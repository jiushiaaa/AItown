<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºäºå¤šAgentååŒçš„èŒ¶äº§å“æ™ºèƒ½è¥é”€ç³»ç»Ÿ</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <link rel="stylesheet" href="TemplateData/admin-style.css">
    <script>
      // å¢åŠ JavaScriptå †æ ˆå¤§å°ï¼Œè§£å†³Maximum call stack size exceededé”™è¯¯
      var oldLimit = Error.stackTraceLimit;
      Error.stackTraceLimit = 50;
    </script>
    <style>
      /* ä¾§è¾¹æ å›¾æ ‡æ ·å¼ */
      .sidebar-menu .icon-placeholder {
        margin-right: 8px;
        display: inline-block !important;
        width: 16px;
        height: 16px;
        text-align: center;
        font-style: normal;
        visibility: visible !important;
        opacity: 1 !important;
      }

      /* æ¯ä¸ªå›¾æ ‡çš„ç‹¬ç‰¹æ ·å¼ */
      .icon-simulation:before {
        content: "ğŸ­"; /* å·¥å‚/æ¨¡æ‹Ÿ */
      }

      .icon-settings:before {
        content: "âš™ï¸"; /* é½¿è½®/è®¾ç½® */
      }

      .icon-dashboard:before {
        content: "ğŸ“Š"; /* å›¾è¡¨/ä»ªè¡¨ç›˜ */
      }

      .icon-user:before {
        content: "ğŸ‘¤"; /* ç”¨æˆ·/äººç‰© */
      }

      .icon-location:before {
        content: "ğŸ—ºï¸"; /* åœ°å›¾/åœ°å€ */
      }

      .icon-opportunity:before {
        content: "ğŸ”"; /* æ”¾å¤§é•œ/åˆ†æ */
      }

      .icon-idea:before {
        content: "ğŸ’¡"; /* ç¯æ³¡/åˆ›æ„ */
      }
      
      /* ç¡®ä¿Unityå†…å®¹æ­£ç¡®æ˜¾ç¤º */
      .main-content {
        position: relative;
        flex: 1;
        padding: 20px;
        overflow: auto;
        height: calc(100vh - 60px);
      }
      
      #unity-container {
        width: 100%;
        height: 100%;
        position: relative;
      }
      
      #unity-canvas {
        width: 100%;
        height: 100%;
        background: #231F20;
      }

      /* å‘½ä»¤è¡Œæ§åˆ¶é¢æ¿æ ·å¼ */
      .command-panel {
        position: absolute;
        left: 20px;  /* ä»å³ä¸‹è§’æ”¹ä¸ºå·¦ä¸‹è§’ */
        bottom: 20px;
        width: 380px;
        background-color: rgba(22, 28, 36, 0.9);
        color: white;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        z-index: 1000;
        font-family: 'Microsoft YaHei', sans-serif;
        border: 1px solid rgba(255, 255, 255, 0.1);
        overflow: hidden;
      }

      .command-panel-header {
        display: flex;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        background-color: rgba(30, 38, 50, 1);
      }

      .command-panel-tab {
        padding: 10px 18px;
        cursor: pointer;
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 14px;
        transition: all 0.2s ease;
      }

      .command-panel-tab.active {
        background-color: rgba(45, 55, 72, 1);
        border-bottom: 2px solid #4e8ed0;
      }

      .command-panel-tab:hover:not(.active) {
        background-color: rgba(40, 49, 64, 1);
      }

      .command-panel-content {
        min-height: 220px;
        max-height: 320px;
        padding: 0;
      }

      .panel-section {
        display: none;
        padding: 15px;
      }

      .panel-section.active {
        display: block;
      }

      .command-button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 15px;
      }

      .command-button {
        background-color: #4361ee;
        border: none;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        letter-spacing: 0.5px;
      }

      .command-button:hover {
        background-color: #3a56d4;
        transform: translateY(-1px);
      }

      .command-input-group {
        display: flex;
        margin-top: 12px;
        border-radius: 6px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      .command-input {
        flex: 1;
        padding: 10px 12px;
        background-color: #2d3748;
        border: 1px solid #4a5568;
        border-right: none;
        color: white;
        font-size: 13px;
      }

      .command-input:focus {
        outline: none;
        border-color: #4e8ed0;
      }

      .send-button {
        padding: 10px 15px;
        background-color: #38b2ac;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.2s ease;
      }

      .send-button:hover {
        background-color: #319795;
      }

      .log-area {
        margin-top: 15px;
        padding: 10px;
        height: 160px;
        overflow-y: auto;
        background-color: #1a202c;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 12px;
        line-height: 1.6;
        white-space: pre-wrap;
        color: #e2e8f0;
        border-radius: 6px;
        border: 1px solid #2d3748;
      }

      .log-entry {
        margin: 3px 0;
        padding-left: 5px;
        border-left: 3px solid transparent;
      }

      .log-entry.info {
        color: #63b3ed;
        border-left-color: #4299e1;
      }

      .log-entry.warning {
        color: #fbd38d;
        border-left-color: #ed8936;
      }

      .log-entry.error {
        color: #feb2b2;
        border-left-color: #e53e3e;
      }

      .connection-info {
        background-color: #2d3748;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 15px;
      }

      .connection-info p {
        margin: 8px 0;
        display: flex;
        justify-content: space-between;
      }

      .connection-info span {
        padding: 4px 8px;
        background-color: #1a202c;
        border-radius: 4px;
      }

      .status-connected {
        color: #68d391;
      }
    </style>
  </head>
  <body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="header">
      <div class="header-menu-toggle">â˜°</div>
      <div class="system-logo">
        èŒ¶äº§å“æ™ºèƒ½è¥é”€ç³»ç»Ÿ
      </div>
      <div class="welcome-text">æ¬¢è¿ è¶…çº§ç®¡ç†å‘˜</div>
      <div class="header-buttons">
        <button class="header-btn" id="changePasswordBtn">
          <i class="icon-placeholder icon-user"></i> ä¿®æ”¹å¯†ç 
        </button>
        <button class="header-btn logout-btn" onclick="logout()">
          <i class="icon-placeholder icon-logout"></i> é€€å‡ºç³»ç»Ÿ
        </button>
      </div>
    </header>

    <!-- å·¦ä¾§è¾¹æ  -->
    <nav class="sidebar">
      <ul class="sidebar-menu">
        <li class="sidebar-item">
          <a href="index.html" class="sidebar-link active">
            <i class="icon-placeholder icon-simulation"></i>
            ä»¿çœŸæ¨¡æ‹Ÿç³»ç»Ÿ
          </a>
        </li>
        <li class="sidebar-item">
          <a href="model-config.html" class="sidebar-link">
            <i class="icon-placeholder icon-settings"></i>
            æ¨¡å‹é…ç½®
          </a>
        </li>
        <li class="sidebar-item">
          <a href="analytics/dashboard.html" class="sidebar-link">
            <i class="icon-placeholder icon-dashboard"></i>
            æ•°æ®æ¦‚è§ˆ
          </a>
        </li>
        <li class="sidebar-item">
          <a href="analytics/consumer.html" class="sidebar-link">
            <i class="icon-placeholder icon-user"></i>
            æ¶ˆè´¹è€…åˆ†æ
          </a>
        </li>
        <li class="sidebar-item">
          <a href="analytics/region.html" class="sidebar-link">
            <i class="icon-placeholder icon-location"></i>
            åœ°åŸŸåˆ†æ
          </a>
        </li>
        <li class="sidebar-item">
          <a href="analytics/psychology.html" class="sidebar-link">
            <i class="icon-placeholder icon-opportunity"></i>
            æ¶ˆè´¹å¿ƒç†åˆ†æ
          </a>
        </li>
        <li class="sidebar-item">
          <a href="analytics/marketing.html" class="sidebar-link">
            <i class="icon-placeholder icon-idea"></i>
            è¥é”€ç­–ç•¥
          </a>
        </li>
      </ul>
    </nav>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="main-content">
      <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas"></canvas>
        <div id="unity-loading-bar">
          <div id="unity-logo"></div>
          <div id="unity-progress-bar-empty">
            <div id="unity-progress-bar-full"></div>
          </div>
        </div>
        <div id="unity-warning"> </div>
        <div id="unity-footer">
          <div id="unity-webgl-logo"></div>
          <div id="unity-fullscreen-button"></div>
          <div id="unity-build-title">åŸºäºå¤šAgentååŒçš„èŒ¶äº§å“æ™ºèƒ½è¥é”€ç³»ç»Ÿ</div>
        </div>
      </div>

      <!-- å‘½ä»¤è¡Œæ§åˆ¶é¢æ¿ -->
      <div class="command-panel">
        <div class="command-panel-header">
          <div class="command-panel-tab active" data-tab="control">æ§åˆ¶é¢æ¿</div>
          <div class="command-panel-tab" data-tab="connection">è¿æ¥çŠ¶æ€</div>
        </div>
        <div class="command-panel-content">
          <div class="panel-section active" id="control-panel">
            <div class="command-button-group">
              <button class="command-button" onclick="sendCommand('design_for_youth')">ä¸ºå¹´è½»äººè®¾è®¡äº§å“</button>
              <button class="command-button" onclick="sendCommand('design_for_white_collar')">ä¸ºç™½é¢†è®¾è®¡äº§å“</button>
              <button class="command-button" onclick="sendCommand('design_for_elderly')">ä¸ºè€å¹´äººè®¾è®¡äº§å“</button>
              <button class="command-button" onclick="sendCommand('design_for_student')">ä¸ºå­¦ç”Ÿè®¾è®¡äº§å“</button>
              <button class="command-button" onclick="sendCommand('analyze_market')">åˆ†æå¸‚åœºéœ€æ±‚</button>
            </div>
            <div class="command-input-group">
              <input type="text" class="command-input" id="command-input" placeholder="è¾“å…¥è‡ªå®šä¹‰å‘½ä»¤...">
              <button class="send-button" onclick="sendCustomCommand()">å‘é€</button>
            </div>
            <div class="log-area" id="log-area">
              <div class="log-entry info">[ç³»ç»Ÿ] æ¬¢è¿ä½¿ç”¨èŒ¶äº§å“æ™ºèƒ½è¥é”€ç³»ç»Ÿ</div>
              <div class="log-entry info">[ç³»ç»Ÿ] è¯·é€‰æ‹©é¢„è®¾å‘½ä»¤æˆ–è¾“å…¥è‡ªå®šä¹‰å‘½ä»¤</div>
              <div class="log-entry info">[ç³»ç»Ÿ] WebGLå¼•æ“å·²åˆå§‹åŒ–ï¼Œç­‰å¾…æŒ‡ä»¤ä¸­...</div>
            </div>
          </div>
          <div class="panel-section" id="connection-panel">
            <div class="connection-info">
              <p>ç³»ç»ŸçŠ¶æ€: <span class="status-connected" id="connection-status">å·²è¿æ¥</span></p>
              <p>è¿æ¥æ—¶é—´: <span id="connection-time">2023-05-15 14:30:22</span></p>
              <p>æ•°æ®åŒæ­¥: <span>æ­£å¸¸</span></p>
            </div>
            <button class="command-button" onclick="reconnectWebSocket()">é‡æ–°è¿æ¥æœåŠ¡å™¨</button>
          </div>
        </div>
      </div>
    </main>

    <!-- ä¿®æ”¹å¯†ç æ¨¡æ€æ¡† -->
    <div id="passwordModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>ä¿®æ”¹å¯†ç </h3>
          <span class="close">&times;</span>
        </div>
        <div class="modal-body">
          <form id="changePasswordForm">
            <div class="form-group">
              <label for="currentPassword">å½“å‰å¯†ç </label>
              <input type="password" id="currentPassword" required>
            </div>
            <div class="form-group">
              <label for="newPassword">æ–°å¯†ç </label>
              <input type="password" id="newPassword" required>
            </div>
            <div class="form-group">
              <label for="confirmPassword">ç¡®è®¤æ–°å¯†ç </label>
              <input type="password" id="confirmPassword" required>
            </div>
            <div class="form-group">
              <p id="passwordError" class="error-message"></p>
            </div>
            <div class="form-buttons">
              <button type="button" class="cancel-btn">å–æ¶ˆ</button>
              <button type="submit" class="submit-btn">ä¿å­˜</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼Œæœªç™»å½•åˆ™é‡å®šå‘åˆ°ç™»å½•é¡µé¢
      if (localStorage.getItem('isLoggedIn') !== 'true' && sessionStorage.getItem('isLoggedIn') !== 'true') {
        window.location.href = 'login.html';
      }
      
      // é€€å‡ºç™»å½•åŠŸèƒ½
      function logout() {
        // æ¸…é™¤æ‰€æœ‰ç™»å½•çŠ¶æ€
        localStorage.removeItem('isLoggedIn');
        sessionStorage.removeItem('isLoggedIn');
        // é‡å®šå‘åˆ°ç™»å½•é¡µé¢
        window.location.href = 'login.html';
      }
      
      // ä¿®æ”¹å¯†ç åŠŸèƒ½
      document.addEventListener('DOMContentLoaded', function() {
        // è·å–DOMå…ƒç´ 
        const modal = document.getElementById('passwordModal');
        const openModalBtn = document.getElementById('changePasswordBtn');
        const closeBtn = document.querySelector('.close');
        const cancelBtn = document.querySelector('.cancel-btn');
        const form = document.getElementById('changePasswordForm');
        const currentPasswordInput = document.getElementById('currentPassword');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const errorMessage = document.getElementById('passwordError');
        
        // æ‰“å¼€æ¨¡æ€æ¡†
        openModalBtn.addEventListener('click', function() {
          modal.classList.add('show');
          // æ¸…ç©ºè¡¨å•
          form.reset();
          errorMessage.textContent = '';
        });
        
        // å…³é—­æ¨¡æ€æ¡†çš„å¤šç§æ–¹å¼
        function closeModal() {
          modal.classList.remove('show');
        }
        
        closeBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.addEventListener('click', function(event) {
          if (event.target === modal) {
            closeModal();
          }
        });
        
        // æäº¤ä¿®æ”¹å¯†ç è¡¨å•
        form.addEventListener('submit', function(event) {
          event.preventDefault();
          
          const currentPassword = currentPasswordInput.value;
          const newPassword = newPasswordInput.value;
          const confirmPassword = confirmPasswordInput.value;
          
          // éªŒè¯å½“å‰å¯†ç 
          if (currentPassword !== 'admin') {
            errorMessage.textContent = 'å½“å‰å¯†ç ä¸æ­£ç¡®ï¼';
            return;
          }
          
          // éªŒè¯æ–°å¯†ç é•¿åº¦
          if (newPassword.length < 6) {
            errorMessage.textContent = 'æ–°å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä¸ªå­—ç¬¦ï¼';
            return;
          }
          
          // éªŒè¯ä¸¤æ¬¡å¯†ç è¾“å…¥æ˜¯å¦ä¸€è‡´
          if (newPassword !== confirmPassword) {
            errorMessage.textContent = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼';
            return;
          }
          
          // ä¿å­˜æ–°å¯†ç ï¼ˆè¿™é‡Œåªæ˜¯æ¨¡æ‹Ÿï¼Œå®é™…åº”ç”¨éœ€è¦åç«¯APIï¼‰
          if (localStorage.getItem('isLoggedIn') === 'true') {
            localStorage.setItem('userPassword', newPassword);
          } else {
            sessionStorage.setItem('userPassword', newPassword);
          }
          
          // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯å¹¶å…³é—­æ¨¡æ€æ¡†
          alert('å¯†ç ä¿®æ”¹æˆåŠŸï¼ä¸‹æ¬¡ç™»å½•è¯·ä½¿ç”¨æ–°å¯†ç ã€‚');
          closeModal();
        });

        // å‘½ä»¤é¢æ¿æ ‡ç­¾åˆ‡æ¢
        const tabs = document.querySelectorAll('.command-panel-tab');
        tabs.forEach(tab => {
          tab.addEventListener('click', function() {
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
            tabs.forEach(t => t.classList.remove('active'));
            // æ·»åŠ å½“å‰æ ‡ç­¾çš„activeç±»
            this.classList.add('active');
            
            // è·å–å¯¹åº”çš„é¢æ¿
            const tabName = this.getAttribute('data-tab');
            const panels = document.querySelectorAll('.panel-section');
            
            // éšè—æ‰€æœ‰é¢æ¿
            panels.forEach(panel => panel.classList.remove('active'));
            
            // æ˜¾ç¤ºå¯¹åº”çš„é¢æ¿
            if (tabName === 'control') {
              document.getElementById('control-panel').classList.add('active');
            } else if (tabName === 'connection') {
              document.getElementById('connection-panel').classList.add('active');
            }
          });
        });
      });
      
      // å‘é€å‘½ä»¤åˆ°Unity
      function sendCommand(command) {
        if (window.unityInstance) {
          window.unityInstance.SendMessage('CommandHandler', 'ExecuteCommand', command);
          
          // æ ¹æ®ä¸åŒçš„å‘½ä»¤ï¼Œç”Ÿæˆé€‚åˆå¤§æ¨¡å‹å¤„ç†çš„é—®é¢˜
          let question = "";
          switch(command) {
            case 'design_for_youth':
              question = "è¯·ä¸ºå¹´è½»äººè®¾è®¡ä¸€æ¬¾èŒ¶äº§å“";
              break;
            case 'design_for_white_collar':
              question = "è¯·ä¸ºç™½é¢†è®¾è®¡ä¸€æ¬¾èŒ¶äº§å“";
              break;
            case 'design_for_elderly':
              question = "è¯·ä¸ºè€å¹´äººè®¾è®¡ä¸€æ¬¾èŒ¶äº§å“";
              break;
            case 'design_for_student':
              question = "è¯·ä¸ºå­¦ç”Ÿè®¾è®¡ä¸€æ¬¾èŒ¶äº§å“";
              break;
            case 'analyze_market':
              question = "è¯·åˆ†æå½“å‰èŒ¶äº§å“å¸‚åœºéœ€æ±‚";
              break;
            default:
              question = command; // é»˜è®¤ä½¿ç”¨å‘½ä»¤æœ¬èº«
          }
          
          // æ ¹æ®ä¸åŒçš„å‘½ä»¤ï¼Œæ˜¾ç¤ºä¸åŒçš„æ—¥å¿—æ¶ˆæ¯
          let message = "";
          switch(command) {
            case 'design_for_youth':
              message = "æ­£åœ¨ä¸ºå¹´è½»äººè®¾è®¡èŒ¶äº§å“...";
              break;
            case 'design_for_white_collar':
              message = "æ­£åœ¨ä¸ºç™½é¢†è®¾è®¡èŒ¶äº§å“...";
              break;
            case 'design_for_elderly':
              message = "æ­£åœ¨ä¸ºè€å¹´äººè®¾è®¡èŒ¶äº§å“...";
              break;
            case 'design_for_student':
              message = "æ­£åœ¨ä¸ºå­¦ç”Ÿè®¾è®¡èŒ¶äº§å“...";
              break;
            case 'analyze_market':
              message = "æ­£åœ¨åˆ†æå¸‚åœºéœ€æ±‚...";
              break;
            default:
              message = `æ‰§è¡Œå‘½ä»¤: ${command}`;
          }
          
          logMessage(message);
          
          // ä½¿ç”¨ç”Ÿæˆçš„é—®é¢˜é€šè¿‡WebSocketå‘é€
          sendCommandViaWebSocket(question);
        } else {
          logMessage('Unityå®ä¾‹å°šæœªå‡†å¤‡å¥½ï¼Œæ— æ³•å‘é€å‘½ä»¤', 'error');
          // å³ä½¿Unityå®ä¾‹æœªå‡†å¤‡å¥½ï¼Œä¹Ÿå‘é€WebSocketå‘½ä»¤
          sendCommandViaWebSocket(command);
        }
      }
      
      // WebSocketè¿æ¥æ–­å¼€å¤„ç†å’Œé‡è¿æœºåˆ¶
      let reconnectAttempts = 0;
      const MAX_RECONNECT_ATTEMPTS = 3;
      let serverShutdownDetected = false;

      // æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€å¹¶æç¤ºç”¨æˆ·
      function checkServerStatus() {
        if (serverShutdownDetected) {
          const statusDiv = document.createElement('div');
          statusDiv.className = 'server-status-alert';
          statusDiv.innerHTML = `
            <div class="alert-content">
              <h3>åç«¯æœåŠ¡å·²å…³é—­</h3>
              <p>æ£€æµ‹åˆ°åç«¯æœåŠ¡å·²å…³é—­ã€‚è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤é‡å¯æœåŠ¡ï¼š</p>
              <ol>
                <li>è¿”å›å‘½ä»¤è¡Œçª—å£</li>
                <li>æŒ‰ä»»æ„é”®å…³é—­å½“å‰ä¼šè¯</li>
                <li>é‡æ–°è¿è¡Œ start_webgl.bat è„šæœ¬</li>
                <li>ç­‰å¾…æœåŠ¡å¯åŠ¨å®Œæˆååˆ·æ–°æ­¤é¡µé¢</li>
              </ol>
              <button id="dismiss-alert">æˆ‘çŸ¥é“äº†</button>
            </div>
          `;
          
          // æ·»åŠ æ ·å¼
          const style = document.createElement('style');
          style.textContent = `
            .server-status-alert {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background-color: rgba(0, 0, 0, 0.7);
              display: flex;
              justify-content: center;
              align-items: center;
              z-index: 9999;
            }
            .alert-content {
              background-color: #f8f9fa;
              color: #212529;
              padding: 20px;
              border-radius: 8px;
              max-width: 500px;
              box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            }
            .alert-content h3 {
              margin-top: 0;
              color: #dc3545;
            }
            .alert-content ol {
              text-align: left;
              padding-left: 20px;
            }
            .alert-content button {
              background-color: #4361ee;
              color: white;
              border: none;
              padding: 8px 16px;
              border-radius: 4px;
              cursor: pointer;
              margin-top: 10px;
            }
            .alert-content button:hover {
              background-color: #3a56d4;
            }
          `;
          document.head.appendChild(style);
          document.body.appendChild(statusDiv);
          
          // æ·»åŠ å…³é—­æŒ‰é’®åŠŸèƒ½
          document.getElementById('dismiss-alert').addEventListener('click', function() {
            document.body.removeChild(statusDiv);
          });
        }
      }

      // åˆå§‹åŒ–WebSocketè¿æ¥
      function initWebSocket(unityInstance) {
        if (window.socket) {
          window.socket.close();
        }
        
        reconnectAttempts++;
        
        try {
          // è¿æ¥åˆ°WebSocketæœåŠ¡å™¨
          window.socket = new WebSocket('ws://127.0.0.1:12339');
          
          // è¿æ¥æˆåŠŸ
          window.socket.onopen = function() {
            logMessage('WebSocketè¿æ¥æˆåŠŸ');
            document.getElementById('connection-status').textContent = 'å·²è¿æ¥';
            document.getElementById('connection-status').className = 'status-connected';
            
            // é‡ç½®é‡è¿è®¡æ•°
            reconnectAttempts = 0;
            serverShutdownDetected = false;
            
            // æ›´æ–°è¿æ¥æ—¶é—´
            const now = new Date();
            document.getElementById('connection-time').textContent = 
              `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            
            // å‘é€åˆå§‹åŒ–æ¶ˆæ¯
            const initMessage = {
              type: 'init',
              source: 'webClient',
              timestamp: new Date().toISOString()
            };
            window.socket.send(JSON.stringify(initMessage));
          };
          
          // æ¥æ”¶æ¶ˆæ¯
          window.socket.onmessage = function(event) {
            try {
              const data = JSON.parse(event.data);
              logMessage(`æ”¶åˆ°æœåŠ¡å™¨æ¶ˆæ¯: ${data.message || JSON.stringify(data)}`);
              
              // å¦‚æœUnityå®ä¾‹å­˜åœ¨ï¼Œå°†æ¶ˆæ¯ä¼ é€’ç»™Unity
              if (window.unityInstance && data.command) {
                window.unityInstance.SendMessage('CommandHandler', 'ExecuteCommand', data.command);
              }
            } catch (e) {
              logMessage(`æ”¶åˆ°æœåŠ¡å™¨æ¶ˆæ¯: ${event.data}`);
            }
          };
          
          // è¿æ¥å…³é—­
          window.socket.onclose = function() {
            logMessage('WebSocketè¿æ¥å·²å…³é—­', 'warning');
            document.getElementById('connection-status').textContent = 'å·²æ–­å¼€';
            document.getElementById('connection-status').className = '';
            
            // å¦‚æœé‡è¿æ¬¡æ•°å°äºæœ€å¤§æ¬¡æ•°ï¼Œå°è¯•é‡è¿
            if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
              logMessage(`å°è¯•é‡æ–°è¿æ¥ (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})...`, 'warning');
              setTimeout(() => {
                initWebSocket(window.unityInstance);
              }, 2000);
            } else {
              // è¶…è¿‡æœ€å¤§é‡è¿æ¬¡æ•°ï¼Œåˆ¤æ–­ä¸ºæœåŠ¡å™¨å·²å…³é—­
              serverShutdownDetected = true;
              logMessage('æœåŠ¡å™¨å¯èƒ½å·²å…³é—­ï¼Œè¯·é‡å¯åç«¯æœåŠ¡', 'error');
              checkServerStatus();
            }
          };
          
          // è¿æ¥é”™è¯¯
          window.socket.onerror = function(error) {
            logMessage('WebSocketè¿æ¥é”™è¯¯', 'error');
            document.getElementById('connection-status').textContent = 'è¿æ¥é”™è¯¯';
            document.getElementById('connection-status').className = '';
            console.error('WebSocketé”™è¯¯:', error);
            
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡å°è¯•è¿æ¥å¤±è´¥ï¼Œå¯èƒ½æ˜¯æœåŠ¡å™¨æœªå¯åŠ¨
            if (reconnectAttempts === 1) {
              serverShutdownDetected = true;
              checkServerStatus();
            }
          };
          
          if (unityInstance) {
            window.unityInstance = unityInstance;
          }
          
          return true;
        } catch (e) {
          logMessage('WebSocketåˆå§‹åŒ–å¤±è´¥: ' + e.message, 'error');
          document.getElementById('connection-status').textContent = 'è¿æ¥å¤±è´¥';
          document.getElementById('connection-status').className = '';
          console.error('WebSocketåˆå§‹åŒ–é”™è¯¯:', e);
          
          // å¦‚æœåˆå§‹åŒ–å¤±è´¥ï¼Œå¯èƒ½æ˜¯æœåŠ¡å™¨æœªå¯åŠ¨
          serverShutdownDetected = true;
          checkServerStatus();
          
          return false;
        }
      }
      
      // é€šè¿‡WebSocketå‘é€å‘½ä»¤åˆ°æœåŠ¡å™¨
      function sendCommandViaWebSocket(command) {
        if (serverShutdownDetected) {
          logMessage('æœåŠ¡å™¨å·²å…³é—­ï¼Œè¯·é‡å¯åç«¯æœåŠ¡', 'error');
          checkServerStatus();
          return;
        }
        
        if (window.socket && window.socket.readyState === WebSocket.OPEN) {
          // ä¿®æ”¹ä¸ºåç«¯æœŸæœ›çš„æ¶ˆæ¯æ ¼å¼ï¼Œä½¿ç”¨ type: "question" å­—æ®µ
          const commandData = {
            type: "question",
            question: command, // å°†å‘½ä»¤æ”¾åœ¨questionå­—æ®µä¸­
            timestamp: new Date().toISOString()
          };
          window.socket.send(JSON.stringify(commandData));
          logMessage('WebSocketå‘½ä»¤å·²å‘é€: ' + command);
        } else {
          // å¦‚æœWebSocketæœªè¿æ¥ï¼Œå°è¯•è¿æ¥
          initWebSocket();
          // è®°å½•é”™è¯¯
          logMessage('WebSocketæœªè¿æ¥ï¼Œå°è¯•é‡æ–°è¿æ¥...', 'warning');
          // å»¶è¿Ÿ500msåé‡è¯•å‘é€
          setTimeout(() => {
            if (window.socket && window.socket.readyState === WebSocket.OPEN) {
              const commandData = {
                type: "question",
                question: command, // å°†å‘½ä»¤æ”¾åœ¨questionå­—æ®µä¸­
                timestamp: new Date().toISOString()
              };
              window.socket.send(JSON.stringify(commandData));
              logMessage('WebSocketå‘½ä»¤å·²å‘é€: ' + command);
            } else {
              logMessage('WebSocketè¿æ¥å¤±è´¥ï¼Œæ— æ³•å‘é€å‘½ä»¤', 'error');
              
              // å¦‚æœé‡è¿å¤±è´¥ï¼Œå¯èƒ½æ˜¯æœåŠ¡å™¨å·²å…³é—­
              if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
                serverShutdownDetected = true;
                checkServerStatus();
              }
            }
          }, 500);
        }
      }
      
      // é‡æ–°è¿æ¥WebSocket
      function reconnectWebSocket() {
        document.getElementById('connection-status').textContent = 'æ­£åœ¨è¿æ¥...';
        if (initWebSocket(window.unityInstance)) {
          logMessage('æ­£åœ¨é‡æ–°è¿æ¥WebSocket...');
        } else {
          logMessage('WebSocketé‡æ–°è¿æ¥å¤±è´¥', 'error');
        }
      }
      
      // å‘é€è‡ªå®šä¹‰å‘½ä»¤
      function sendCustomCommand() {
        const commandInput = document.getElementById('command-input');
        const command = commandInput.value.trim();
        
        if (command) {
          sendCommand(command);
          commandInput.value = '';
        }
      }
      
      // æ·»åŠ æ—¥å¿—
      function logMessage(message, type = 'info') {
        const logArea = document.getElementById('log-area');
        const now = new Date();
        const timeString = `[${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}]`;
        
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry ${type}`;
        logEntry.textContent = `${timeString} ${message}`;
        
        logArea.appendChild(logEntry);
        logArea.scrollTop = logArea.scrollHeight;
      }
      
      // ç§»åŠ¨ç«¯èœå•åˆ‡æ¢
      document.querySelector('.header-menu-toggle').addEventListener('click', function() {
        document.querySelector('.sidebar').classList.toggle('active');
        document.querySelector('.main-content').classList.toggle('sidebar-active');
      });
      
      var container = document.querySelector("#unity-container");
      var canvas = document.querySelector("#unity-canvas");
      var loadingBar = document.querySelector("#unity-loading-bar");
      var progressBarFull = document.querySelector("#unity-progress-bar-full");
      var fullscreenButton = document.querySelector("#unity-fullscreen-button");
      var warningBanner = document.querySelector("#unity-warning");

      // Shows a temporary message banner/ribbon for a few seconds, or
      // a permanent error message on top of the canvas if type=='error'.
      // If type=='warning', a yellow highlight color is used.
      // Modify or remove this function to customize the visually presented
      // way that non-critical warnings and error messages are presented to the
      // user.
      function unityShowBanner(msg, type) {
        function updateBannerVisibility() {
          warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
        }
        var div = document.createElement('div');
        div.innerHTML = msg;
        warningBanner.appendChild(div);
        if (type == 'error') div.style = 'background: red; padding: 10px;';
        else {
          if (type == 'warning') div.style = 'background: yellow; padding: 10px;';
          setTimeout(function() {
            warningBanner.removeChild(div);
            updateBannerVisibility();
          }, 5000);
        }
        updateBannerVisibility();
      }

      var buildUrl = "Build";
      var loaderUrl = buildUrl + "/web.loader.js";
      var config = {
        dataUrl: buildUrl + "/web.data",
        frameworkUrl: buildUrl + "/web.framework.js",
        codeUrl: buildUrl + "/web.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "åŸºäºå¤šAgentååŒçš„èŒ¶äº§å“æ™ºèƒ½è¥é”€ç³»ç»Ÿ",
        productVersion: "1.0",
        showBanner: unityShowBanner,
      };

      // By default Unity keeps WebGL canvas render target size matched with
      // the DOM size of the canvas element (scaled by window.devicePixelRatio)
      // Set this to false if you want to decouple this synchronization from
      // happening inside the engine, and you would instead like to size up
      // the canvas DOM size and WebGL render target sizes yourself.
      // config.matchWebGLToCanvasSize = false;

      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        // Mobile device style: fill the whole browser client area with the game canvas:

        var meta = document.createElement('meta');
        meta.name = 'viewport';
        meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
        document.getElementsByTagName('head')[0].appendChild(meta);
        container.className = "unity-mobile";
        canvas.className = "unity-mobile";

        // To lower canvas resolution on mobile devices to gain some
        // performance, uncomment the following line:
        // config.devicePixelRatio = 1;

        unityShowBanner('WebGL builds are not supported on mobile devices.');
      } else {
        // Desktop style: Render the game canvas in a window that can be maximized to fullscreen:
        canvas.style.width = "100%";
        canvas.style.height = "100%";
      }

      loadingBar.style.display = "block";

      var script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        // å¢åŠ å†…å­˜é™åˆ¶ï¼Œé˜²æ­¢WebGLå †æ ˆæº¢å‡º
        if (typeof UnityLoader !== 'undefined' && UnityLoader.SystemInfo) {
          UnityLoader.SystemInfo.hasWebGL = (function(old) {
            return function() {
              // å¢åŠ WebGLè°ƒç”¨å †æ ˆå¤§å°
              Error.stackTraceLimit = 100;
              return old.apply(this, arguments);
            }
          })(UnityLoader.SystemInfo.hasWebGL);
        }
        
        createUnityInstance(canvas, config, (progress) => {
          progressBarFull.style.width = 100 * progress + "%";
        }).then((unityInstance) => {
          window.unityInstance = unityInstance; // å­˜å‚¨Unityå®ä¾‹ä»¥ä¾¿å‘½ä»¤è¡Œä½¿ç”¨
          loadingBar.style.display = "none";
          fullscreenButton.onclick = () => {
            unityInstance.SetFullscreen(1);
          };
          // å°è¯•åˆå§‹åŒ–WebSocketè¿æ¥
          initWebSocket(unityInstance);
          logMessage('Unityå®ä¾‹åŠ è½½å®Œæˆï¼Œç³»ç»Ÿå‡†å¤‡å°±ç»ª');
          
          // ä¸»åŠ¨å°è¯•å‘é€ä¸€æ¡æµ‹è¯•æ¶ˆæ¯
          setTimeout(() => {
            sendCommandViaWebSocket('system_init');
            logMessage('å·²å‘é€ç³»ç»Ÿåˆå§‹åŒ–å‘½ä»¤');
          }, 1000);
        }).catch((message) => {
          alert(message);
          logMessage('Unityå®ä¾‹åŠ è½½å¤±è´¥: ' + message, 'error');
          // å³ä½¿UnityåŠ è½½å¤±è´¥ï¼Œä¹Ÿå°è¯•åˆå§‹åŒ–WebSocket
          initWebSocket();
        });
      };
      document.body.appendChild(script);

      // æŒ‰å›è½¦å‘é€å‘½ä»¤
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
          const commandInput = document.getElementById('command-input');
          if (document.activeElement === commandInput) {
            sendCustomCommand();
            event.preventDefault();
          }
        }
      });
    </script>
  </body>
</html>
